"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Recorder=function(){function e(t){var i=this;if(_classCallCheck(this,e),this.visualizerContext=t,this.recordButton=document.querySelector("#record"),this.deleteButton=document.querySelector("#delete"),!SUPPORTS_MEDIA_RECORDER)return this.recordButton.parentNode.removeChild(this.recordButton),void this.deleteButton.parentNode.removeChild(this.deleteButton);this.recorder=!1,this.chunks=[],this.recordButton.addEventListener("click",this.visualizerContext.record.bind(this.visualizerContext)),this.deleteButton.addEventListener("click",function(){i.chunks=[],URL.revokeObjectURL(i.objURL),i.objURL=null,i.recordButton.classList.remove("recorded"),i.visualizerContext.useMicrophone()})}return _createClass(e,[{key:"record",value:function(e){var t=this;return new Promise(function(i,s){t.recorder=new MediaRecorder(e),t.recorder.ondataavailable=function(e){t.chunks.push(e.data)},t.recorder.start(0),t.recordButton.classList.add("recording"),t.recordButton.innerHTML='<i class="material-icons">stop</i><span>Stop recording</span>';t.recordButton.removeEventListener("click",t.visualizerContext.record),t.recordButton.addEventListener("click",function e(){var s=new Blob(t.chunks,{type:"audio/ogg; codecs=opus"});t.chunks=[],t.objURL=URL.createObjectURL(s),i(t.objURL),t.recordButton.removeEventListener("click",e),t.recordButton.addEventListener("click",t.visualizerContext.record),t.recordButton.classList.remove("recording"),t.recordButton.classList.add("recorded"),t.recordButton.innerHTML='<i class="material-icons">mic</i><span>Record audio</span>',t.recordButton.classList.add("recorded")})})}},{key:"hide",value:function(){this.recordButton.style.display="none",this.deleteButton.style.display="none"}},{key:"show",value:function(){this.recordButton.style.display="",this.deleteButton.style.display=""}}]),e}(),AudioControls=function(){function e(t,i){_classCallCheck(this,e),this.time=document.querySelector("#currentTime"),this.visualizer=t,this.canvas=i,this.ctx=this.canvas.getContext("2d"),this.rect=this.canvas.getBoundingClientRect(),this.canvas.width=this.rect.width,this.canvas.height=this.rect.height,this.colors={main:"#26a69a",background:"#333",disabled:"rgba(255, 255, 255, 0.5)"},this.TAU=2*Math.PI,this.NINETY_DEGREES=1.57079633,this.SIXTY_DEGREES=1.04719755,this.addEventListeners(),this.animationLoop()}return _createClass(e,[{key:"getCurrentTimeAsPercentage",value:function(){return this.seeking?this.currentSeekTime/this.visualizer.audio.duration:this.visualizer.audio.currentTime/this.visualizer.audio.duration}},{key:"play",value:function(){this.visualizer.audio.play()}},{key:"pause",value:function(){this.visualizer.recordingWaveform||this.visualizer.audio.pause()}},{key:"togglePlayState",value:function(){this.seeking?this.seeking=!1:this.paused?this.play():this.pause()}},{key:"setTime",value:function(e){this.time.innerHTML=e||""}},{key:"timeUpdate",value:function(e,t){if(void 0!==t||!this.seeking){var i=new Number,s=new Number;i=Math.floor(this.visualizer.audio.duration),s=(s=Math.floor(i/60))>=10?s:"0"+s,i=(i=Math.floor(i%60))>=10?i:"0"+i;var r=new Number,o=new Number;r=Math.floor(t||this.visualizer.audio.currentTime),o=(o=Math.floor(r/60))>=10?o:"0"+o,r=(r=Math.floor(r%60))>=10?r:"0"+r,this.currentTime=o+":"+r,this.totalTIme=s+":"+i,this.currentTime.indexOf("NaN")>-1&&(this.currentTime="00:00"),this.totalTIme.indexOf("NaN")>-1&&(this.totalTIme="00:00"),this.setTime(this.currentTime+"/"+this.totalTIme)}}},{key:"normalizeInput",value:function(e){var t=e.touches?e.touches[0]:e,i=t.clientX,s=t.clientY,r=this.canvas.getBoundingClientRect();return i-=r.left+r.width/2,s-=r.top+r.height/2,{x:i,y:s}}},{key:"onMove",value:function(e){var t=this.normalizeInput(e),i=Math.atan2(t.y,t.x)+.5*Math.PI;i<0&&(i=this.TAU+i),this.currentSeekTime=i/this.TAU*this.visualizer.audio.duration,this.timeUpdate(null,this.currentSeekTime)}},{key:"addEventListeners",value:function(){var e=this;this.visualizer.audio.addEventListener("play",this.play.bind(this)),this.visualizer.audio.addEventListener("pause",this.pause.bind(this)),this.visualizer.audio.addEventListener("timeupdate",this.timeUpdate.bind(this)),this.canvas.addEventListener("click",this.togglePlayState.bind(this)),this.animationLoop=this.animationLoop.bind(this);var t=function(t){if(!e.visualizer.recordingWaveform){e.mousedown=!0;var i=e.normalizeInput(t);Math.sqrt(Math.pow(i.x,2)+Math.pow(i.y,2))>e.rect.width/2*.75&&(e.seeking=!0,e.onMove(t))}},i=function(t){if(e.mousedown)return t.preventDefault(),e.seeking=!0,e.onMove(t),!1},s=function(t){e.mousedown=!1,e.seeking&&(e.visualizer.audio.currentTime=e.currentSeekTime),e.seeking&&t.target!==e.canvas&&e.togglePlayState()};this.canvas.addEventListener("mousedown",t),this.canvas.addEventListener("touchstart",t),document.addEventListener("mousemove",i),document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("mouseup",s),document.addEventListener("touchend",s)}},{key:"triangle",value:function(e,t,i){var s=e*(Math.sqrt(3)/2);this.ctx.save(),this.ctx.translate(t,i),this.ctx.beginPath(),this.ctx.moveTo(0,-s/2),this.ctx.lineTo(-e/2,s/2),this.ctx.lineTo(e/2,s/2),this.ctx.closePath(),this.ctx.restore()}},{key:"rotate",value:function(e,t,i){this.ctx.translate(e,t),this.ctx.rotate(i),this.ctx.translate(-e,-t)}},{key:"drawPlayButton",value:function(e){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e,e,.752*e,0,this.TAU),this.ctx.closePath(),this.ctx.fillStyle=this.colors.main,this.ctx.fill(),this.rotate(e,e,this.NINETY_DEGREES),this.triangle(50,e,e-3.5),this.ctx.fillStyle=this.colors.background,this.ctx.fill(),this.ctx.restore()}},{key:"drawAmplitude",value:function(e){this.ctx.save(),this.ctx.beginPath(),this.ctx.translate(e,e);var t=45.46605+(.75*e-45.46605)*this.visualizer.currentAmplitude;isNaN(t)&&(t=45.46605),this.ctx.arc(0,0,t,0,this.TAU),this.ctx.closePath(),this.ctx.fillStyle=this.colors.main,this.ctx.fill(),this.ctx.restore()}},{key:"drawPauseButton",value:function(e){this.drawAmplitude(e),this.ctx.fillStyle=this.colors.background,this.ctx.fillRect(e-21.6505,e-25,15,50),this.ctx.fillRect(e+21.6505-15,e-25,15,50)}},{key:"animationLoop",value:function(){this.colors.main=this.visualizer.recordingWaveform?"#ef5350":this.colors.main;var e=.5*this.rect.width;this.ctx.restore(),this.ctx.save(),this.ctx.clearRect(0,0,this.rect.width,this.rect.height),this.rotate(e,e,-this.NINETY_DEGREES),this.ctx.beginPath(),this.ctx.moveTo(e,e),this.ctx.arc(e,e,e,0,this.getCurrentTimeAsPercentage()*this.TAU),this.ctx.closePath(),this.ctx.fillStyle=this.colors.main,this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(e,e),this.ctx.arc(e,e,.75*e,0,this.TAU),this.ctx.closePath(),this.ctx.fillStyle="#222",this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(e,e),this.ctx.arc(e,e,.75*e-4,0,this.TAU),this.ctx.closePath(),this.ctx.fillStyle=this.colors.background,this.ctx.fill(),this.ctx.restore(),this.paused?this.drawPlayButton(e):this.visualizer.recordingWaveform?this.drawAmplitude(e):this.drawPauseButton(e),this.visualizer.srcIsMP3||(this.ctx.beginPath(),this.ctx.moveTo(e,e),this.ctx.arc(e,e,e,0,this.TAU),this.ctx.closePath(),this.ctx.fillStyle=this.colors.disabled,this.ctx.fill()),queueFrame(this.animationLoop)}},{key:"paused",get:function(){return this.visualizer.audio.paused}}]),e}(),Visualizer=function(){function e(){if(_classCallCheck(this,e),SUPPORTS_WEB_AUDIO){SUPPORTS_MEDIA_RECORDER||document.querySelector('[value="other:microphone"]').parentNode.removeChild(document.querySelector('[value="other:microphone"]')),this.audio=document.querySelector("audio"),this.audioContext=new WEB_AUDIO,this.audioControls=new AudioControls(this,document.querySelector("#audioControls")),this.source=this.audioContext.createMediaElementSource(this.audio),this.trackSelector=document.querySelector("#track"),this.audio.src=this.trackSelector.value,this.recorder=new Recorder(this),this.recorder.hide(),this.waveformOverTime=document.querySelector("#waveformOverTime"),this.frequencyDomain=document.querySelector("#frequencyDomain"),this.waveform=document.querySelector("#waveform"),this.waveformOverTimeContext=this.waveformOverTime.getContext("2d"),this.frequencyDomainContext=this.frequencyDomain.getContext("2d"),this.waveformContext=this.waveform.getContext("2d"),this.analyser=this.audioContext.createAnalyser(),this.analyser.connect(this.audioContext.destination),this.defaultSmoothingTimeConstant=this.analyser.smoothingTimeConstant=.5,this.muteGain=this.audioContext.createGain(),this.muted=!1,this.muteGain.gain.value=0,this.analyser.connect(this.muteGain),this.muteGain.connect(this.audioContext.destination),this.filterFrequencyLabel=document.querySelector('[for="filterFrequency"]'),this.filterFrequencyDetailed=document.querySelector('[for="filterFrequency"] > input'),this.filterFrequency=document.querySelector("#filterFrequency"),this.filterTypeLabel=document.querySelector('[for="filter"]'),this.filterType=document.querySelector("#filter"),this.oscillatorFrequencyLabel=document.querySelector('[for="oscillatorFrequency"]'),this.oscillatorFrequencyDetailed=document.querySelector('[for="oscillatorFrequency"] > input'),this.oscillatorFrequency=document.querySelector("#oscillatorFrequency"),this.oscillatorTypeLabel=document.querySelector('[for="oscillatorType"]'),this.oscillatorType=document.querySelector("#oscillatorType"),this.frequencyBinCount=this.analyser.frequencyBinCount,this.frequencyData=new Uint8Array(this.frequencyBinCount),this.waveformData=new Uint8Array(this.frequencyBinCount),this.lastConnectedToAnalyser=null,this.filter=this.audioContext.createBiquadFilter(),this.filter.type="allpass",this.filter.Q.value=.05,this.filter.gain.value=15,this.oscillator=this.audioContext.createOscillator(),this.oscillator.start(0),this.microphone=null,this.srcIsMP3=!0,this.source.connect(this.filter);var t=this.waveform.getBoundingClientRect();this.height=t.height,this.width=t.width,this.waveformOverTime.width=this.width,this.waveformOverTime.height=this.height,this.frequencyDomain.width=this.width,this.frequencyDomain.height=this.height,this.waveform.width=this.width,this.waveform.height=this.height,this.time=Date.now(),this.pausedTime=0,this.timeScale=6e4,this.lastTimeX=0,this.timeMax=0,this.timeMin=0,this.currentAmplitude=0,this.frequencyWidth=this.width/this.frequencyBinCount,this.frequencyGrd=this.frequencyDomainContext.createLinearGradient(0,0,0,this.height),this.frequencyGrd.addColorStop(0,"rgb(255, 0, 0)"),this.frequencyGrd.addColorStop(1,"rgb(0,255,100)"),this.waveformGrd=this.waveformContext.createLinearGradient(0,0,0,this.height),this.waveformGrd.addColorStop(0,"rgb(255, 0, 0)"),this.waveformGrd.addColorStop(.5,"rgb(0,255,100)"),this.waveformGrd.addColorStop(1,"rgb(255, 0, 0)"),this.waveformOverTimeContext.fillStyle=this.waveformGrd,this.frequencyDomainContext.fillStyle=this.frequencyGrd,this.frequencyDomainContext.lineJoin="round",this.frequencyDomainContext.lineCap="round",this.waveformContext.strokeStyle=this.waveformGrd,this.waveformContext.lineJoin="round",this.waveformContext.lineCap="round",this.addEventListeners(),this.paused=!1,this.hideAuxControls(),this.showAuxControls("filterType"),this.setInputDevice(this.filter),queueFrame(this.updateVisualizer)}}return _createClass(e,[{key:"setInputDevice",value:function(e){this.disconnectAnalyser(),this.lastConnectedToAnalyser=e,e.connect(this.analyser)}},{key:"useOscillator",value:function(){this.analyser.smoothingTimeConstant=0,this.showAuxControls("oscillatorFrequency"),this.showAuxControls("oscillatorType"),this.setInputDevice(this.oscillator)}},{key:"useMicrophone",value:function(){var e=this;this.resetSource();var t=function(){e.recorder.objURL?e.setSrcAsObjectURL(e.recorder.objURL):(e.setInputDevice(e.microphone),e.recorder.show(),e.mute())};this.microphone?t():navigator.mediaDevices.getUserMedia({audio:!0}).then(function(i){e.microphoneStream=i,e.microphone=e.audioContext.createMediaStreamSource(i),t()}).catch(function(e){return console.log(e)})}},{key:"disconnectAnalyser",value:function(){this.lastConnectedToAnalyser&&(this.lastConnectedToAnalyser.disconnect(this.analyser),this.lastConnectedToAnalyser=null)}},{key:"updateVisualizer",value:function(){if(queueFrame(this.updateVisualizer),!this.paused||!this.srcIsMP3){this.analyser.getByteTimeDomainData(this.waveformData),this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyDomainContext.clearRect(0,0,this.width,this.height),this.waveformContext.clearRect(0,0,this.width,this.height),this.frequencyDomainContext.beginPath(),this.waveformContext.beginPath(),this.frequencyDomainContext.moveTo(0,this.height);var e=(Date.now()-this.time)/this.timeScale*this.width,t=e-this.lastTimeX;this.waveformOverTimeContext.fillRect(this.lastTimeX,this.timeMin,t,this.timeMax-this.timeMin),this.lastTimeX=e,this.timeMax=Math.max.apply(null,this.waveformData)/255*this.height,this.timeMin=Math.min.apply(null,this.waveformData)/255*this.height;for(var i=0,s=0,r=0,o=void 0,n=void 0,a=0;a<this.frequencyBinCount;a++){o=this.frequencyData[a]/255*this.height,n=this.height-o,this.frequencyDomainContext.lineTo(i,n);var h=this.waveformData[a]/255*this.height;0===a?this.waveformContext.moveTo(i,h):this.waveformContext.lineTo(i,h),i+=this.frequencyWidth,0!==this.frequencyData[a]&&(s+=this.frequencyData[a],r++)}this.currentAmplitude=s/r/255,e>this.width&&(this.pauseAtEnd?(this.pause(),this.pauseAtEnd=!1):this.clearAll()),this.frequencyDomainContext.lineTo(this.width,this.height),this.frequencyDomainContext.closePath(),this.frequencyDomainContext.fill(),this.waveformContext.lineTo(this.width,this.height/2),this.waveformContext.stroke()}}},{key:"record",value:function(){var e=this;this.recorder.record(this.microphoneStream).then(function(t){e.setSrcAsObjectURL(t)})}},{key:"setSrcAsObjectURL",value:function(e){this.pause(),this.resetSource(),this.srcIsMP3=!0,this.audio.src=e,this.audio.loop=!0,this.play(),this.showAuxControls("filterType"),"allpass"!==this.filter.type&&this.showAuxControls("filterFrequency")}},{key:"play",value:function(){this.time+=Date.now()-this.time-this.pausedTime,this.pausedTime=0,this.paused=!1,this.audio.play()}},{key:"pause",value:function(e){this.paused=!0,this.pausedTime=Date.now()-this.time,this.audio.pause()}},{key:"hide",value:function(e){e.style.display="none"}},{key:"show",value:function(e){e&&e.style&&(e.style.display="")}},{key:"mute",value:function(){this.muted||(this.analyser.disconnect(this.audioContext.destination),this.muted=!0)}},{key:"unmute",value:function(){this.muted&&(this.analyser.connect(this.audioContext.destination),this.muted=!1)}},{key:"hideAuxControls",value:function(){this.hide(this.filterType),this.hide(this.filterTypeLabel),this.hide(this.filterFrequencyLabel),this.hide(this.filterFrequency),this.hide(this.oscillatorFrequencyLabel),this.hide(this.oscillatorFrequency),this.hide(this.oscillatorTypeLabel),this.hide(this.oscillatorType)}},{key:"showAuxControls",value:function(e){this.show(this[e]),this.show(this[e+"Label"])}},{key:"resetSource",value:function(){this.hideAuxControls(),this.analyser.smoothingTimeConstant=this.defaultSmoothingTimeConstant,this.unmute(),this.audio.src="",this.audio.loop=!1,this.clearAll(),this.setInputDevice(this.filter)}},{key:"clearAll",value:function(){this.waveformOverTimeContext.clearRect(0,0,this.width,this.height),this.waveformContext.clearRect(0,0,this.width,this.height),this.frequencyDomainContext.clearRect(0,0,this.width,this.height),this.time=Date.now(),this.lastTimeX=0,this.pausedTime=0}},{key:"addEventListeners",value:function(){var e=this,t=null;this.updateVisualizer=this.updateVisualizer.bind(this),this.audio.addEventListener("play",this.play.bind(this)),this.audio.addEventListener("pause",this.pause.bind(this)),this.trackSelector.addEventListener("change",function(t){switch(e.pause(),e.clearAll(),e.resetSource(),e.srcIsMP3=!1,e.droppedFile&&URL.revokeObjectURL(e.droppedFile),e.droppedFile=!1,e.trackSelector.value){case"other:oscillator":e.useOscillator();break;case"other:microphone":e.useMicrophone();break;default:e.srcIsMP3=!0,e.audio.src=e.trackSelector.value,e.showAuxControls("filterType"),"allpass"!==e.filter.type&&e.showAuxControls("filterFrequency")}e.play()}),document.addEventListener("dragover",function(e){return e.preventDefault(),document.querySelector("#dragdrop").classList.add("show"),!1},!1),document.addEventListener("dragleave",function(){document.querySelector("#dragdrop").classList.remove("show")},!1),document.addEventListener("drop",function(t){return t.preventDefault(),t.stopPropagation(),document.querySelector("#dragdrop").classList.remove("show"),!(!t.dataTransfer.files[0]||!/audio|video/i.test(t.dataTransfer.files[0].type))&&(e.pause(),e.clearAll(),e.resetSource(),e.srcIsMP3=!0,e.droppedFile=URL.createObjectURL(t.dataTransfer.files[0]),e.audio.src=e.droppedFile,e.showAuxControls("filterType"),"allpass"!==e.filter.type&&e.showAuxControls("filterFrequency"),e.play(),!1)},!1);var i=document.querySelector("#timeScale"),s=document.querySelector('[for="timeScale"] > input'),r=function(t){t.target===i&&(s.value=i.value),e.timeScale=1e3*s.value,e.clearAll()};i.addEventListener("change",r),s.addEventListener("change",r);var o=function(t){t.target===e.oscillatorFrequency&&(e.oscillatorFrequencyDetailed.value=e.oscillatorFrequency.value),e.oscillatorFrequency.value=e.oscillatorFrequencyDetailed.value,e.oscillator.frequency.value=e.oscillatorFrequencyDetailed.value,e.clearAll()};this.oscillatorFrequencyDetailed.addEventListener("change",o),this.oscillatorFrequency.addEventListener("change",o),this.oscillatorFrequency.addEventListener("mousedown",function(){t={source:e.oscillatorFrequency,dest:e.oscillator.frequency}}),this.oscillatorType.addEventListener("change",function(){e.oscillator.type=e.oscillatorType.value});var n=function(t){t.target===e.filterFrequency&&(e.filterFrequencyDetailed.value=e.filterFrequency.value),e.filterFrequency.value=e.filterFrequencyDetailed.value,e.filter.frequency.value=e.filterFrequencyDetailed.value};this.filterFrequencyDetailed.addEventListener("change",n),this.filterFrequency.addEventListener("change",n),this.filterFrequency.addEventListener("mousedown",function(){t={source:e.filterFrequency,dest:e.filter.frequency}}),this.filterType.addEventListener("change",function(){"allpass"===e.filterType.value?(e.filterFrequencyLabel.style.display="none",e.filterFrequency.style.display="none"):(e.showAuxControls("filter"),e.showAuxControls("filterFrequency")),e.filter.type=e.filterType.value,e.filter.frequency.value=e.filter.frequency.defaultValue,e.filterFrequency.value=e.filter.frequency.defaultValue,e.filterFrequencyDetailed.value=e.filter.frequency.defaultValue}),document.addEventListener("mousemove",function(e){t&&(t.dest.value=t.source.value)}),document.addEventListener("mouseup",function(e){t&&(e.preventDefault(),t=!1)});var a=document.querySelector("#recordWaveform");this.recordingWaveform=!1,a.addEventListener("click",function(t){e.recordingWaveform||(e.recordingWaveform=!0,a.classList.add("red"),a.disabled=!0,a.innerHTML='<i class="material-icons">radio_button_checked</i> Recording . . .',e.clearAll(),e.hideAuxControls(),e.audio.currentTime=0,e.play(),s.value=Math.ceil(e.audio.duration),e.timeScale=1e3*Math.ceil(e.audio.duration),e.pauseAtEnd=!0,e.audio.loop=!1,e.audio.addEventListener("ended",function(t){var i=e.waveformOverTime.toDataURL(),s=document.createElement("a");s.download="waveform.png",s.href=i,document.body.appendChild(s),s.click(),window.location.reload()}))})}},{key:"pauseAtEnd",get:function(){return document.querySelector("#pauseAtEnd").checked},set:function(e){document.querySelector("#pauseAtEnd").checked=e}}]),e}(),visualizer=new Visualizer;